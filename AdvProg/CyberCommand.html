<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>CYBER COMMAND</title>
<style>
  /* 【最重要】@importを<style>タグの最上部に移動し、フォントを正しく読み込む */
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap');
  
  /* スクロール完全無効化のため、html要素に高さを固定しオーバーフローを禁止 */
  html {
    height: 100%;
    overflow: hidden; 
  }

  :root{
    --bg:#010409;
    --txt:#8bdcff;
    --neon:#18c6ff;
    --neon-soft:#18c6ff2b;
    --ok:#9ff0d4;
    --gap: clamp(22px, 5vw, 52px);

    /* D-pad sizes */
    --pad-size: clamp(52px, 14.5vw, 68px);
    --pad-gap: clamp(8px, 3.2vw, 14px);
  }

  /* ==== Background (subtle grid) ==== */
  body{
    margin:0; min-height:100svh; color:var(--txt);
    font-family:'Orbitron',sans-serif;
    background:var(--bg);
    /* デスクトップのレイアウト（元の状態） */
    display:flex; align-items:center; justify-content:center; 
    padding: calc(var(--gap) * 1.6) var(--gap);
    -webkit-user-select:none; user-select:none; touch-action:manipulation;
    overflow-x:hidden;
    /* bodyも念のためY軸のスクロールを隠す */
    overflow-y:hidden; 
    position:relative;
  }
  body::before{
    content:""; position:absolute; inset:0; z-index:-2;
    background-image:
      linear-gradient(var(--neon-soft) 1px, transparent 1px),
      linear-gradient(90deg, var(--neon-soft) 1px, transparent 1px);
    background-size:64px 64px;
    animation:gridMove 12s linear infinite;
  }
  @keyframes gridMove{
    0%{ background-position:0 0, 0 0; }
    100%{ background-position:64px 64px, 64px 64px; }
  }

  /* ==== Main (no frame) ==== */
  .card{
    width:min(900px, 95vw);
    border:none; box-shadow:none; background:transparent; border-radius:0;
    padding: calc(var(--gap) * 1.1) var(--gap);
    text-align:center;
  }

  h1{
    margin:0 0 calc(var(--gap) * .9);
    letter-spacing:3px; font-weight:700;
    font-size: clamp(1.9rem, 2.7rem, 3.1rem);
    color: var(--txt);
    text-shadow: 0 0 8px rgba(24,198,255,.35);
  }

  #score{
    /* PC表示時のSCOREの文字サイズを大きく戻す (clamp(1.4rem, 4.5vw, 1.8rem)相当) */
    font-size: clamp(1.4rem, 4.5vw, 1.8rem); 
    color:#7fd5ff;
    display:block; margin: 0 auto calc(var(--gap) * .7);
    text-shadow: 0 0 6px rgba(24,198,255,.28);
  }

  #instruction{
    font-size: clamp(2rem, 6.2vw, 3.1rem);
    font-weight:800; letter-spacing:.06em;
    margin: calc(var(--gap) * .6) 0 calc(var(--gap) * .7);
    color:#cfefff; 
    text-shadow: 0 0 10px rgba(24,198,255,.3);
    /* D-Pad位置固定のため、PC側で高さを固定 */
    height: 3.5rem; 
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Timer bar */
  #timerWrap{
    width:min(560px, 88%);
    height:12px; margin: 0 auto calc(var(--gap) * .9);
    background:#0a2330; border:1px solid rgba(24,198,255,.38); border-radius:6px;
    overflow:hidden; display:none; box-shadow: inset 0 0 6px rgba(24,198,255,.25);
  }
  #timerBar{ height:100%; width:100%; background: linear-gradient(90deg, #e3fbff, var(--neon)); }

  #message{
    font-size:1.1rem; margin-top: calc(var(--gap) * .35); min-height:1.5rem;
    color: var(--ok); text-shadow: 0 0 6px rgba(159,240,212,.25);
  }

  .actions{ margin-top: calc(var(--gap) * .9); }
  .btn{
    background:transparent; color:#bdf0ff;
    border:2px solid rgba(24,198,255,.8); border-radius:0;
    padding:14px 32px; font-size:1.08rem;
    font-family:'Orbitron',sans-serif; text-transform:uppercase; letter-spacing:2px;
    cursor:pointer; transition: transform .18s ease, box-shadow .18s ease, background .18s ease;
    box-shadow: 0 0 10px rgba(24,198,255,.28);
  }
  .btn:hover{ background:rgba(24,198,255,.1); box-shadow: 0 0 18px rgba(24,198,255,.45); }
  .btn:active{ transform: translateY(1px); }

  /* ==== D-Pad (hidden on desktop) ==== */
  .controls{ display:none; }
  .dpad{
    display:grid;
    grid-template-columns:repeat(3, var(--pad-size));
    grid-template-rows:repeat(3, var(--pad-size));
    gap: var(--pad-gap);
    padding:12px;
  }
  .control-btn{
    width:var(--pad-size); height:var(--pad-size);
    display:grid; place-items:center;   
    border:2px solid rgba(24,198,255,.8); border-radius:0;
    background:transparent; color:#bdf0ff; font-weight:700;
    box-shadow: 0 0 10px rgba(24,198,255,.28);
    transition: transform .06s ease, background .18s ease;
    cursor:pointer;
  }
  .control-btn:active{ transform: scale(.96); background:rgba(24,198,255,.1); }
  .control-btn svg{
    /* 矢印のサイズを90%で維持 */
    width:90%; height:90%;              
    stroke: currentColor; fill:none; stroke-width:10;
    stroke-linecap:round; stroke-linejoin:round;
  }
  .ghost{ width:var(--pad-size); height:var(--pad-size); opacity:0; }

  /* ==== Mobile: flow layout (no overlap) ==== */
  @media (max-width: 760px){
    body{
      min-height:100svh;
      /* モバイル時のFlexbox設定 */
      display:flex; flex-direction:column;
      justify-content:space-between; align-items:center;
      
      /* スクロール対策としてoverflow-yをhiddenに設定 */
      overflow-y:hidden; 
      
      /* bodyのpadding-bottomはcontrolsで確保するため、最小限に */
      padding:
        max(12px, env(safe-area-inset-top))
        var(--gap)
        max(12px, env(safe-area-inset-bottom)); 
    }
    .card{
      width:min(980px, 94vw);
      /* コンテンツを上に移動 */
      margin-top: clamp(8px, 4svh, 32px);
      padding: var(--gap) var(--gap);
      
      /* 90%に縮小し、中央に配置してD-Pad分のスペースを確保 */
      transform: scale(.9); 
      /* 縮小で要素の基準位置がずれるため、位置調整 */
      transform-origin: top center; 
      
      /* D-Padとの間隔を確保するため、マージンを大きく設定 */
      margin-bottom: clamp(60px, 15vw, 90px); 
    }
    h1{ font-size: clamp(1.6rem, 8.5vw, 2.4rem); margin-bottom: clamp(16px, 4.5vw, 26px); }
    
    /* モバイル時のSCOREの文字サイズは、親の#scoreの設定が適用されるため個別設定を削除 */
    
    #instruction{ 
      font-size: clamp(1.6rem, 8.4vw, 2.3rem); 
      margin: clamp(10px, 3.6vw, 18px) 0 clamp(14px, 4.2vw, 22px); 
      /* D-Pad位置固定のため、モバイルで高さを固定（これでボタン位置が動かない） */
      height: 6rem; 
      line-height: 1.3;
    }

    #timerWrap{ margin-bottom: clamp(14px, 4.2vw, 24px); }
    .actions{ margin-top: clamp(14px, 4.2vw, 24px); }

    .controls{
      display:flex;            /* show D-pad */
      width:100%;
      justify-content:center;
      
      /* D-Padを画面下部に固定 */
      position: fixed;
      /* ★ 修正: bottomの値をさらにマイナスにし、D-Padを画面外へ強く押し下げて重なりを解消 */
      bottom: -100px; 
      left: 0;
      right: 0;
      z-index: 100; /* 最前面に表示 */
      background: transparent; /* 背景色を透明にし、グリッドを表示 */

      /* bottom:-100pxに設定したため、padding-bottomを調整 */
      padding-bottom: calc(max(6px, env(safe-area-inset-bottom)) + 140px);
    }
  }

  @media (prefers-reduced-motion: reduce){
    *{ animation:none !important; transition:none !important; }
  }
</style>
</head>
<body>
  <div class="card" role="application" aria-label="反射神経ゲーム">
    <h1>CYBER COMMAND</h1>
    <div id="score">SCORE: 0</div>
    <div id="instruction"></div>
    <div id="timerWrap" aria-hidden="true"><div id="timerBar"></div></div>
    <div class="actions">
      <button id="startBtn" class="btn" type="button" aria-label="START">START</button>
    </div>
    <div id="message" aria-live="polite"></div>
  </div>

  <div class="controls" role="group" aria-label="方向入力">
    <div class="dpad">
      <div class="ghost"></div>
      <button class="control-btn" data-key="ArrowUp" aria-label="上">
        <svg viewBox="0 0 100 100" aria-hidden="true">
          <path d="M50 80 V30 M50 30 L32 48 M50 30 L68 48"/>
        </svg>
      </button>
      <div class="ghost"></div>

      <button class="control-btn" data-key="ArrowLeft" aria-label="左">
        <svg viewBox="0 0 100 100" aria-hidden="true">
          <path d="M70 50 H20 M20 50 L38 32 M20 50 L38 68"/>
        </svg>
      </button>
      <div class="ghost"></div>
      <button class="control-btn" data-key="ArrowRight" aria-label="右">
        <svg viewBox="0 0 100 100" aria-hidden="true">
          <path d="M30 50 H80 M80 50 L62 32 M80 50 L62 68"/>
        </svg>
      </button>

      <div class="ghost"></div>
      <button class="control-btn" data-key="ArrowDown" aria-label="下">
        <svg viewBox="0 0 100 100" aria-hidden="true">
          <path d="M50 20 V70 M50 70 L32 52 M50 70 L68 52"/>
        </svg>
      </button>
      <div class="ghost"></div>
    </div>
  </div>

<script>
/* ===== 既存のゲームロジック（変更なし） ===== */
const DIRS = ["右","左","上","下"];
const KEYMAP = {
  "右": ["ArrowRight","d","D"],
  "左": ["ArrowLeft","a","A"],
  "上": ["ArrowUp","w","W"],
  "下": ["ArrowDown","s","S"]
};
const rand  = (arr) => arr[Math.floor(Math.random()*arr.length)];
const union = (a,b)=> Array.from(new Set([...a,...b]));
const ALLOWED_KEYS = new Set(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","w","W","a","A","s","S","d","D"]);

let currentInstruction = null;
let score = 0;
let timeoutId = null;
let postDelayId = null;
let acceptingInput = false;
let isRunning = false;

let timeLimit = 3000;
const minTimeLimit = 1000;
const speedUp = 200;

const instructionEl = document.getElementById("instruction");
const scoreEl       = document.getElementById("score");
const messageEl     = document.getElementById("message");
const startBtn      = document.getElementById("startBtn");
const timerWrap     = document.getElementById("timerWrap");
const timerBar      = document.getElementById("timerBar");

/* High score */
const HS_KEY = "reactionGameHighScore";
const getHighScore = () => {
  const v = Number(localStorage.getItem(HS_KEY));
  return Number.isFinite(v) ? v : 0;
};
const setHighScore = (v) => localStorage.setItem(HS_KEY, String(v));

/* Timer bar */
function startTimer(ms){
  timerWrap.style.display = "block";
  timerBar.style.transition = "none";
  timerBar.style.width = "100%";
  void timerBar.offsetWidth;
  timerBar.style.transition = `width ${ms}ms linear`;
  requestAnimationFrame(()=>{ timerBar.style.width = "0%"; });
}
function stopTimer(){
  timerBar.style.transition = "none";
  timerBar.style.width = "0%";
}

/* Dynamic instruction */
const keysFor = (dir)=> KEYMAP[dir];
function buildInstruction(){
  const base = rand([...DIRS, "無視"]);
  if (base === "無視") return { text:"無視", ignore:true };

  const modifiers = ["plain","not","notnot","notnotnot","igai","denai","matawa"];
  const mod = rand(modifiers);
  switch(mod){
    case "plain":       return { text: base, correct: keysFor(base) };
    case "not":         return { text: `${base}じゃない`, avoid: keysFor(base) };
    case "notnot":      return { text: `${base}じゃないじゃない`, correct: keysFor(base) };
    case "notnotnot":   return { text: `${base}じゃないじゃないじゃない`, avoid: keysFor(base) };
    case "igai":        return { text: `${base}以外`, avoid: keysFor(base) };
    case "denai":       return { text: `${base}ではない`, avoid: keysFor(base) };
    case "matawa": {
      const other = rand(DIRS.filter(d=>d!==base));
      return { text: `${base} または ${other}`, correct: union(keysFor(base), keysFor(other)) };
    }
    default:            return { text: base, correct: keysFor(base) };
  }
}

/* Flow */
function nextInstruction(){
  clearTimeout(timeoutId); clearTimeout(postDelayId);
  messageEl.textContent = "";

  currentInstruction = buildInstruction();
  instructionEl.textContent = currentInstruction.text;
  acceptingInput = true;
  startTimer(timeLimit);

  timeoutId = setTimeout(()=>{
    if (!acceptingInput) return;
    acceptingInput = false; stopTimer();
    if (currentInstruction.ignore){
      success(); // 何も押さなかった＝正解
    } else {
      endGame();
    }
  }, timeLimit);
}

/* Input */
function processKey(key){
  if (!isRunning || !acceptingInput) return;
  if (!ALLOWED_KEYS.has(key)) return; // 許可外は無視

  if (currentInstruction.ignore){
    acceptingInput = false; clearTimeout(timeoutId); stopTimer(); endGame(); return;
  }
  if (currentInstruction.correct){
    if (currentInstruction.correct.includes(key)){
      acceptingInput = false; clearTimeout(timeoutId); stopTimer(); success();
    } else {
      acceptingInput = false; clearTimeout(timeoutId); stopTimer(); endGame();
    }
  } else if (currentInstruction.avoid){
    if (currentInstruction.avoid.includes(key)){
      acceptingInput = false; clearTimeout(timeoutId); stopTimer(); endGame();
    } else {
      acceptingInput = false; clearTimeout(timeoutId); stopTimer(); success();
    }
  }
}

/* Success / End */
function success(){
  score++;
  scoreEl.textContent = "SCORE: " + score;
  messageEl.textContent = "正解！"; // 日本語のまま
  timeLimit = Math.max(minTimeLimit, timeLimit - speedUp);
  clearTimeout(postDelayId);
  postDelayId = setTimeout(nextInstruction, 800);
}
function endGame(){
  isRunning = false; acceptingInput = false;
  clearTimeout(timeoutId); clearTimeout(postDelayId);
  const prevHigh = getHighScore();
  const isNew = score > prevHigh; const high = isNew ? score : prevHigh;
  if (isNew) setHighScore(high);

  instructionEl.textContent = "GAME OVER!";
  messageEl.textContent = `HIGH SCORE: ${high}${isNew ? "（更新！）" : ""}`;
  timerWrap.style.display = "none";
  startBtn.textContent = "RESTART";
  startBtn.style.display = "inline-block";
}

/* Start / Abort */
function startGame(){
  isRunning = true; score = 0; timeLimit = 3000;
  scoreEl.textContent = "SCORE: 0"; messageEl.textContent = "";
  instructionEl.textContent = "準備中…"; // 日本語そのまま
  startBtn.style.display = "none";
  timerWrap.style.display = "block";
  clearTimeout(timeoutId); clearTimeout(postDelayId);
  nextInstruction();
}
function abortToStart(){ // Esc → タイトル
  isRunning = false; acceptingInput = false;
  clearTimeout(timeoutId); clearTimeout(postDelayId); stopTimer();
  timerWrap.style.display = "none";
  instructionEl.textContent = ""; // PRESS STARTは出さない
  messageEl.textContent = "";
  score = 0; scoreEl.textContent = "SCORE: 0";
  startBtn.textContent = "START";
  startBtn.style.display = "inline-block";
}

/* Handlers */
function handleKeydown(e){
  if (!isRunning && (e.code === "Space" || e.key === " ")){
    e.preventDefault(); startGame(); return;
  }
  if (isRunning && e.key === "Escape"){
    e.preventDefault(); abortToStart(); return;
  }
  if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)) e.preventDefault();
  processKey(e.key);
}
function bindDpad(){
  document.querySelectorAll(".control-btn").forEach(btn=>{
    btn.addEventListener("pointerdown", (e)=>{
      e.preventDefault();
      const key = btn.getAttribute("data-key");
      processKey(key);
    });
  });
}

/* Boot */
const startBtnEl = document.getElementById("startBtn");
if (startBtnEl) startBtnEl.addEventListener("click", startGame);
window.addEventListener("keydown", handleKeydown, { passive:false });
bindDpad();
</script>
</body>
</html>